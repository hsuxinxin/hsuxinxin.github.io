---
layout: post
category : [JVM]
tagline: "Supporting tagline"
tags : [BTrace]
---
{% include JB/setup %}

BTrace是一个安全动态的跟踪java程序的工具。BTrace通过hotswap技术，动态地注入字节码到运行的java程序中。

#术语

 - **Probe Point**
在何处执行我们希望注入的trace语句, 这里的"何处"可以是具体的跟踪地点和执行事件,。在BTrace中通过各种注解来指定 

 - **Trace Actions or Actions** 
我们希望执行的trace语句
 
 - **Action Methods** 
定义在trace脚本中的trace语句, 具体来说就是脚本中的无返回值静态方法

#BTrace 程序结构
BTrace程序是由一个或多个如以下示例一样拥有BTrace注释的方法构成的。

        public static void
        
BTrace注释是用来标识需要跟踪的地方（Probe Point）。跟踪的行为在静态的方法体里面定义，这些方法被称为“action”方法

#BTrace限制

为了保证trace语句对目标跟踪程序的侵入是只读的（不能改变目标跟踪程序的状态）且有限的（跟踪脚本代码必须在有限的时间内完成）, BTrace对trace脚本有一些限制：

BTrace class不能新建类, 新建数组, 抛异常, 捕获异常

不能调用实例方法以及静态方法(com.sun.btrace.BTraceUtils除外)

不能将目标程序的类和对象赋值

不能定义外部, 内部, 匿名, 本地类

不能有同步块和方法

不能有循环

不能实现接口, 不能扩展类

不能使用assert语句, 不能使用class字面值

#简单的BTrace示例

##下载BTrace包
 https://kenai.com/projects/btrace/downloads/directory/releases
 我下载的版本是  release-1.2.5.1 
##解压缩
  打开bin文件夹执行如下语句
     
        chmod +x btrace
  
##目标程序内容
 		 		
        import java.util.Random;  
        public class Case1 {  
        	public static void main(String[] args) throws Exception {  
        		Random random = new Random();  
        		CaseObject object = new CaseObject();  
        		boolean result = true;  
        		while (result) {  
        			result = object.execute(random.nextInt(1000));  
        			Thread.sleep(1000);  
        		}  
        	}  
        }  
         
        public class CaseObject {  
        	private static int sleepTotalTime = 0;   
        	public boolean execute(int sleepTime) throws Exception {  
        	System.out.println("sleep: " + sleepTime);  
        	sleepTotalTime += sleepTime;  
        	Thread.sleep(sleepTime);  
        	return true;  
        	}  
        }  
 

 